# SARIMAXのメモリ消費問題と解決策

## 概要
SARIMAX（季節調整付き自己回帰和分移動平均モデル）は、時系列データの季節性やトレンドを考慮した解析・予測に広く用いられるが、実装時にメモリ消費が異常に大きくなりプロセスが落ちる現象が報告されている。

---

## 問題の発生状況
- データサイズは2,000行程度、float64型、外生変数（exog）は未使用。
- SARIMAXのfit時、パラメータ1セットでもメモリ確保エラーでプロセスが落ちる。
- 探索空間の広さや並列処理の有無は関係なく、単体実行でも発生。
- Windows環境で発生。

---

## 原因の考察
- データ量が小さいにもかかわらず、fit時に内部で差分系列を都度計算・保持するため、環境やBLAS/LAPACK実装によってはメモリ消費が急増する場合がある。
- statsmodelsやnumpy/scipyのバージョン依存バグ、Python環境の競合、データ内容（NaN, inf, 極端値）なども影響しうる。

---

## 解決策
### simple_differencingオプションの活用
- `simple_differencing=True`を指定すると、事前に差分を計算してからモデル化するため、内部での冗長なデータ保持や計算が抑制され、メモリ効率が大幅に向上する。
- このオプションはstatsmodels 0.13以降で追加され、特にmacOSや一部のBLAS実装環境で顕著な効果が報告されている。

#### 参考実装例
```python
import numpy as np
from statsmodels.tsa.statespace.sarimax import SARIMAX

y = np.random.randn(2000).astype(np.float64)
model = SARIMAX(y, order=(1,1,1), seasonal_order=(1,1,1,12),
                enforce_stationarity=False, enforce_invertibility=False,
                simple_differencing=True)
results = model.fit(disp=False)
```

---

## simple_differencing=True の意味とメリット・デメリット

### 意味
statsmodelsのSARIMAXモデルで`simple_differencing=True`を指定すると、モデル内部で必要な差分（d階差分や季節差分）を「事前に」データに適用し、その差分済みデータを使ってパラメータ推定を行う。デフォルト（False）の場合は、モデル内部で差分処理を逐次的・動的に行いながら推定する。

### メリット
- 差分済みデータを使うことで、内部での冗長なデータコピーや複雑な行列演算が減り、メモリ消費が大幅に抑制される。
- fitの計算時間が短縮される場合がある。
- データ量が小さくても発生する「fit時のメモリ確保エラー」など、statsmodels特有の実装トラブルを回避できる。

### デメリット・注意点
- 差分を事前に適用することで、欠損値の扱いや系列長が変わり、推定結果がデフォルトと微妙に異なる場合がある。
- 外生変数（exog）や複雑な季節構造を持つ場合、結果の再現性に注意が必要。
- statsmodelsのバージョンやモデルの設定によっては、`simple_differencing=True`がサポートされていない場合がある。
- 差分前後で系列の統計的性質が変化するため、理論的な解釈や残差分析の際に注意が必要。

---

## なぜ simple_differencing のデフォルト値は True でないのか？
- SARIMAXは理論的に「元データ」に対して状態空間モデルを適用する設計であり、厳密な再現性やAPI互換性を重視しているため。
- デフォルトをTrueにすると、欠損値や外生変数の扱い、系列長、推定結果が従来と変わるリスクがある。
- 既存コードや研究の再現性を守るため、利便性よりも理論的厳密性・後方互換性を優先している。

---

## 反証的視点・注意点
- `simple_differencing=True`は一部のモデル設定やデータ構造で推定結果が微妙に変わる場合があるため、検証が必要。
- データの健全性（NaN, inf, 極端値）やstatsmodels/numpy/scipyのバージョンも確認すること。
- fitの最適化手法（method）やオプションも状況に応じて調整する。

---

## 関連・リンク推奨
- [[SARIMAによる時系列異常検知の基礎]]：SARIMA/SARIMAXの理論と応用全般
- [[定常性とは何か_その判定方法]]：パラメータ選定や差分系列の意義
- [[ADF検定とは何か_その考え方]]：定常性判定の実践例

---

## タグ
#時系列解析 #sarima #statsmodels #メモリ最適化 #python #実装トラブル


[//begin]: # "Autogenerated link references for markdown compatibility"
[SARIMAによる時系列異常検知の基礎]: SARIMA%E3%81%AB%E3%82%88%E3%82%8B%E6%99%82%E7%B3%BB%E5%88%97%E7%95%B0%E5%B8%B8%E6%A4%9C%E7%9F%A5%E3%81%AE%E5%9F%BA%E7%A4%8E.md "SARIMAによる時系列異常検知の基礎"
[定常性とは何か_その判定方法]: %E5%AE%9A%E5%B8%B8%E6%80%A7%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B_%E3%81%9D%E3%81%AE%E5%88%A4%E5%AE%9A%E6%96%B9%E6%B3%95.md "定常性とは何か、その判定方法"
[ADF検定とは何か_その考え方]: ADF%E6%A4%9C%E5%AE%9A%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B_%E3%81%9D%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9.md "ADF検定（Augmented Dickey-Fuller test）とは何か、その考え方"
[//end]: # "Autogenerated link references"
