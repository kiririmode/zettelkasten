# tcpdumpによるパケットキャプチャの専門解説

## 定義・概要

tcpdumpはUNIX系OSで広く利用されるパケットキャプチャツールであり、ネットワークインタフェース上を流れるパケットを詳細に記録・解析できる。主にトラブルシューティング、セキュリティ監査、通信プロトコルの挙動解析など、ネットワークの専門家や運用管理者にとって不可欠なツールである。

## 代表的なオプション一覧

| オプション | 意味・用途 | 補足 |
|:---|:---|:---|
| `-i <iface>` | インタフェース指定 | 例: `-i en0`、`-i eth0` |
| `-nn` | アドレス・ポートの名前解決を抑止 | パフォーマンス・正確性向上 |
| `-w <file>` | キャプチャをバイナリファイル保存 | Wireshark等で解析可能 |
| `-r <file>` | 保存したファイルを再読込・解析 | オフライン解析用 |
| `-c <num>` | 指定パケット数で自動終了 | 例: `-c 100` |
| `-s <snaplen>` | 1パケットあたりの最大バイト数 | 例: `-s 0`で全長取得 |
| `-v`/`-vv`/`-vvv` | 詳細表示レベル | `v`が多いほど詳細 |
| `-X` | パケット内容を16進+ASCIIで表示 | デバッグ・調査向け |
| `port <num>` | ポート番号でフィルタ | 例: `port 80` |
| `host <addr>` | IPアドレスでフィルタ | 例: `host 192.168.1.1` |
| `src`/`dst` | 送信元/宛先でフィルタ | `src port 53`など |
| `and`/`or`/`not` | 複合条件 | 例: `src 10.0.0.1 and dst port 443` |

### 主要オプションの詳細解説

#### -nnオプション（名前解決抑止）のメリット
- `-nn`を指定すると、tcpdumpはIPアドレスやポート番号の名前解決（DNSや/etc/services参照）を行わず、生の数値で出力する。
- これにより、キャプチャや表示のパフォーマンスが大幅に向上し、不要なDNSクエリ発生によるネットワークへの影響やノイズを防げる。
- また、観測対象ネットワーク外への名前解決通信が発生しないため、セキュリティ監査やトラブルシューティング時の情報漏洩リスクを低減できる。
- 生のIPアドレス・ポート番号を記録することで、後から正確な解析や再現がしやすくなる。
- 名前解決結果に依存しないため、CDNやDNSキャッシュの影響による誤認も防げる。

#### -s 0（snaplen=0）指定の是非について
- `-s 0`は「パケット全体（ヘッダ＋ペイロード）を漏れなくキャプチャ」するための指定。アプリ層データや詳細なペイロード解析が必要な場合に有効。
- ただし、全バイト記録によりキャプチャファイルが非常に大きくなりやすく、ストレージ消費やパフォーマンスへの影響がある。
- 通常のトラブルシューティングやヘッダ情報のみで十分な場合は、デフォルト値（OS依存）や小さめのsnaplen（例: `-s 96`など）で効率化できる。
- セキュリティやプライバシー配慮の観点からも、全ペイロード記録が不要な場合はsnaplenを小さくすることで漏洩リスクを抑制できる。
- したがって「常に-s 0を指定すべき」ではなく、目的・状況に応じて使い分けるのが専門的な運用となる。

## 代表的な使い方（コマンド例）
- インタフェース全体のパケットをキャプチャしファイル保存：
  ```zsh
  sudo tcpdump -i en0 -nn -w capture.pcap
  ```
- 特定ポート（例: 80番HTTP）だけをキャプチャ：
  ```zsh
  sudo tcpdump -i en0 port 80
  ```
- DNSパケット（UDP 53番）をリアルタイムで観察：
  ```zsh
  sudo tcpdump -i en0 port 53
  ```
- パケット内容を詳細表示（-vvv）しつつ、条件で絞り込み：
  ```zsh
  sudo tcpdump -i en0 -vvv src net 192.168.1.0/24 and dst port 443
  ```

## 実践的なポイント
- キャプチャファイル（.pcap）はWireshark等GUIツールで詳細解析可能。
- macOSではインタフェース名（例: en0, en1, lo0）を`ifconfig`で確認。
- root権限が必要な場合が多い。
- zshではワイルドカードやパイプ利用時のクォートに注意。

## 批判的視点・反論
- tcpdumpはパケットの内容をそのまま記録するため、個人情報や機密情報の漏洩リスクがある。運用時は十分な権限管理と保存データの取り扱いに注意が必要。
- 名前解決（逆引きDNS）は必ずしも正確でなく、CDNやキャッシュの影響でIPとドメインの対応が一意でない場合がある。
- 暗号化通信（HTTPS等）の中身は復号できないため、通信先やメタ情報の解析に留まる。
- 全ての通信がDNSクエリを伴うとは限らず、IP直指定通信はドメイン特定が困難。
- 補完ツール（Wireshark等）と併用することで可視化や詳細解析が容易になる。

## 関連ノート/リンク
- [[tsharkコマンド_Wiresharkコマンドライン版パケット解析]]
- [[Docker_コンテナ通信_宛先ドメイン確認_tcpdump_Wireshark]]
- [[Claude_Code_ネットワーク要件まとめ]]

#network #security #packetcapture


[//begin]: # "Autogenerated link references for markdown compatibility"
[Docker_コンテナ通信_宛先ドメイン確認_tcpdump_Wireshark]: Docker_%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E9%80%9A%E4%BF%A1_%E5%AE%9B%E5%85%88%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E7%A2%BA%E8%AA%8D_tcpdump_Wireshark.md "Dockerコンテナ通信の宛先ドメイン確認方法"
[Claude_Code_ネットワーク要件まとめ]: Claude_Code_%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E8%A6%81%E4%BB%B6%E3%81%BE%E3%81%A8%E3%82%81.md "Claude Codeに必要なネットワーク要件まとめ"
[//end]: # "Autogenerated link references"
