# tsharkコマンド：Wiresharkコマンドライン版パケット解析

## 定義・概要

tsharkはWiresharkパッケージに含まれるコマンドライン版パケット解析ツールである。Wiresharkの強力な解析エンジンをCLI環境で利用でき、GUI版のWiresharkと同等の豊富なプロトコル解析機能を持つ。tcpdumpと比較して、より高度なフィルタリング、詳細なプロトコル解析、多様な出力形式に対応しており、スクリプト化や自動化に適している。

## 詳細コンテンツ

### tsharkの特徴とtcpdumpとの違い

tsharkはWiresharkのコア解析エンジンを利用するため、tcpdumpよりも豊富なプロトコル解析機能を持つ。tcpdumpが基本的なパケットヘッダ情報の表示に留まるのに対し、tsharkはHTTP、DNS、TLS、SMBなど数百のプロトコルを深く解析し、アプリケーション層の詳細な情報まで抽出できる。また、Wiresharkのディスプレイフィルタ（display filter）をそのまま使用でき、より直感的で高度な条件指定が可能である。

### 主要オプション一覧

#### 基本的なキャプチャ・表示オプション

| オプション | 意味・用途 | 補足・例 |
|:---|:---|:---|
| `-i <interface>` | インタフェース指定 | 例: `-i en0`, `-i any` |
| `-c <count>` | 指定パケット数で停止 | 例: `-c 100` |
| `-a <criterion>` | 自動停止条件 | 例: `-a duration:60`（60秒後停止） |
| `-f <filter>` | キャプチャフィルタ（BPF） | tcpdump互換、例: `port 80` |
| `-Y <filter>` | ディスプレイフィルタ | Wireshark形式、例: `http.host` |
| `-r <file>` | ファイルから読み込み | pcap/pcapng形式 |
| `-w <file>` | ファイルに保存 | pcapng形式で保存 |

#### 出力フォーマット・詳細度オプション

| オプション | 意味・用途 | 補足・例 |
|:---|:---|:---|
| `-V` | 完全なパケット詳細表示 | プロトコル層ごとの詳細情報 |
| `-x` | 16進ダンプ表示 | パケット内容のHex表示 |
| `-T <format>` | 出力形式指定 | `text`, `tabs`, `csv`, `json`, `ek` |
| `-E <option>` | 出力エンコーディング指定 | CSV/JSON出力時のオプション |
| `-t <format>` | タイムスタンプ形式 | `a`（絶対時刻）、`r`（相対時刻）等 |
| `-q` | 静寂モード | 統計情報のみ表示 |

#### 高度な解析・フィルタリングオプション

| オプション | 意味・用途 | 補足・例 |
|:---|:---|:---|
| `-z <statistics>` | 統計情報表示 | 例: `-z io,phs`（プロトコル階層統計） |
| `-G <seconds>` | ローテーション間隔 | ファイル分割保存 |
| `-d <protocol>` | プロトコル解析強制 | 例: `-d tcp.port==8080,http` |
| `-o <preference>` | Wireshark設定の上書き | 例: `-o tcp.desegment_tcp_streams:FALSE` |
| `-S` | 区切り文字指定 | タブ区切り出力等 |

### 実用的なコマンド例と解説

#### 基本的なパケットキャプチャ
```bash
# インタフェース指定してリアルタイム表示
tshark -i en0

# HTTPトラフィックのみを詳細表示
tshark -i en0 -Y "http" -V

# 100パケットをファイルに保存
tshark -i en0 -c 100 -w capture.pcapng
```

#### 高度なフィルタリング例
```bash
# 特定ホストとのHTTPS通信のみ
tshark -i en0 -Y "ip.addr==192.168.1.100 and ssl"

# DNSクエリの詳細解析
tshark -i en0 -Y "dns.flags.response==0" -T json

# HTTPリクエストのホスト名とURIを抽出
tshark -r capture.pcapng -Y "http.request" -T fields -e http.host -e http.request.uri
```

#### 統計・解析機能の活用
```bash
# プロトコル階層統計
tshark -r capture.pcapng -z io,phs

# 通信相手（エンドポイント）統計
tshark -r capture.pcapng -z endpoints,ip

# HTTPレスポンス状況統計
tshark -r capture.pcapng -z http,stat
```

### JSON/CSV出力による自動化対応

tsharkの大きな利点の一つは、構造化された出力形式への対応である。`-T json`オプションにより、パケット情報をJSON形式で出力でき、jqコマンドやPythonスクリプトとの連携が容易になる。また、`-T fields`と`-e`オプションの組み合わせにより、必要なフィールドのみを抽出してCSV形式で出力することも可能である。

#### JSON出力例
```bash
# HTTPリクエストをJSON形式で出力
tshark -r capture.pcapng -Y "http.request" -T json > http_requests.json

# 特定フィールドのみをCSV形式で出力
tshark -r capture.pcapng -T fields -e frame.time -e ip.src -e ip.dst -e tcp.dstport -E header=y -E separator=, > connections.csv
```

### プロトコル解析の詳細度とカスタマイズ

tsharkはWiresharkの解析エンジンを継承しており、数百のプロトコルに対応している。また、`-d`オプションにより非標準ポートで動作するプロトコルの解析を強制したり、`-o`オプションでWiresharkの設定を上書きしてTCP再組み立ての有効/無効を制御したりできる。これにより、特殊な環境やカスタムプロトコルの解析にも対応可能である。

## 批判的視点・反論

### パフォーマンスと資源消費の懸念

tsharkはWiresharkの解析エンジンを利用するため、tcpdumpと比較してCPU・メモリ消費量が大きい。特に高トラフィック環境では、詳細な解析処理がボトルネックとなり、パケットドロップが発生する可能性がある。また、プロトコル解析の複雑さから、tcpdumpより起動時間も長くなる傾向がある。

### プライバシーとセキュリティの考慮

tsharkの高度な解析機能は、同時にプライバシーリスクも増大させる。アプリケーション層の詳細情報まで抽出できるため、暗号化されていない通信では機密情報が露出する危険性がある。また、JSON/CSV出力機能により、大量の通信データが構造化された形で保存されるため、情報漏洩時の影響範囲がより広範囲に及ぶ可能性がある。

### ディスプレイフィルタの複雑性

Wiresharkのディスプレイフィルタは強力だが、BPF（Berkeley Packet Filter）と異なる文法を持つため、tcpdumpに慣れたユーザには学習コストが発生する。また、ディスプレイフィルタは全パケットをキャプチャしてから後処理でフィルタリングするため、キャプチャフィルタ（BPF）よりも効率が劣る場合がある。

### プラットフォーム依存性

tsharkはWiresharkパッケージの一部として配布されるため、tcpdumpのように多くのUNIX系OSに標準でインストールされているわけではない。特に組み込み機器やミニマル環境では、Wiresharkパッケージのインストールが困難な場合があり、tcpdumpの方が汎用性に優れることが多い。

## 関連ノート/リンク

- [[tcpdump_パケットキャプチャ専門解説]]
- [[Docker_コンテナ通信_宛先ドメイン確認_tcpdump_Wireshark]]
- [[Claude_Code_ネットワーク要件まとめ]]

#network #packetcapture #wireshark #cli #security #protocolanalysis

[//begin]: # "Autogenerated link references for markdown compatibility"
[tcpdump_パケットキャプチャ専門解説]: tcpdump_%E3%83%91%E3%82%B1%E3%83%83%E3%83%88%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E5%B0%82%E9%96%80%E8%A7%A3%E8%AA%AC.md "tcpdump パケットキャプチャ専門解説"
[Docker_コンテナ通信_宛先ドメイン確認_tcpdump_Wireshark]: Docker_%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E9%80%9A%E4%BF%A1_%E5%AE%9B%E5%85%88%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E7%A2%BA%E8%AA%8D_tcpdump_Wireshark.md "Dockerコンテナ通信の宛先ドメイン確認方法"
[Claude_Code_ネットワーク要件まとめ]: Claude_Code_%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E8%A6%81%E4%BB%B6%E3%81%BE%E3%81%A8%E3%82%81.md "Claude Codeに必要なネットワーク要件まとめ"
[//end]: # "Autogenerated link references"
