# VS Code Copilot CustomizationのInstructionsとPrompts

## 概要

VS CodeのCopilot Customizationでは、AIレスポンスをカスタマイズする3つの主要な手法が提供されている：Custom Instructions、Prompt Files、Custom Chat Modesである。これらの機能により、開発者は繰り返し同じコンテキストを入力する必要なく、プロジェクトのコーディング規約や要件に合致したAIからの応答を得ることができる。

## Custom Instructions（カスタム指示）の目的と特徴

### 目的
Custom Instructionsは、コード生成、コードレビュー、コミットメッセージ生成などのタスクに対して共通のガイドラインやルールを定義するために使用される。これは「タスクがどのように実行されるべきか」という条件を記述し、開発者の特定のコーディング慣行と技術スタックに合致したレスポンスを自動的に得ることを可能にする。

### 実装方法
Custom Instructionsには3つの実装方法が存在する：

1. **`.github/copilot-instructions.md`ファイル**: ワークスペース内に保存され、すべてのチャットリクエストに自動的に含まれる。すべてのエディタとIDEで対応し、一般的なコーディング慣行やプロジェクト要件を定義するのに適している。

2. **`.instructions.md`ファイル**: より柔軟な制御が可能で、Globパターンを使用して特定のファイルに対してのみ適用することができる。ワークスペースまたはユーザープロファイルに保存可能で、タスク固有の指示を定義する場合に有効である。

3. **VS Code設定**: コード生成以外のタスク（テスト生成、コードレビュー、コミットメッセージなど）に対する指示を定義する際に使用する。

### 活用事例
例えば、TypeScriptプロジェクトでプライベートフィールドにアンダースコアを使用する規約や、AI生成コードにコメントを追加する規約などを定義できる。これにより、チーム全体で一貫性のあるコード生成が可能になる。

### タスク固有Instructions設定の適用タイミング

VS Code設定では、異なる種類のタスクに対して特定のinstructionsを定義することができ、それぞれ明確な適用条件を持つ：

#### コード生成（codeGeneration.instructions）
- **適用タイミング**: 新しいコードの生成を求める一般的なリクエスト時
- **具体例**: 「リストをソートする関数を実装して」「ログインハンドラーを追加して」
- **自動適用範囲**: コード生成プロンプトのデフォルト指示として機能

#### テスト生成（testGeneration.instructions）
- **適用タイミング**: テスト作成を明示的に要求した場合のみ
- **具体例**: 「この関数のテストを書いて」「ユニットテストを生成して」
- **自動適用範囲**: テスト生成専用、通常のコード提案や他のチャットシナリオには適用されない

#### コードレビュー（reviewSelection.instructions）
- **適用タイミング**: 選択されたコードのレビューを要求した場合
- **具体例**: 「このコードをレビューして」「選択されたコードの問題を見つけて」
- **自動適用範囲**: コードレビューアクション専用、特にテキスト選択が入力として提供された場合

#### コミットメッセージ生成（commitMessageGeneration.instructions）
- **適用タイミング**: コミットメッセージの生成を要求した場合のみ
- **具体例**: UIコマンドまたは「これらの変更のコミットメッセージを生成して」
- **自動適用範囲**: コミットメッセージ生成ワークフロー専用

#### プルリクエスト説明生成（pullRequestDescriptionGeneration.instructions）
- **適用タイミング**: プルリクエストの説明文作成を要求した場合のみ
- **具体例**: PRの変更内容の要約や説明を依頼した場合
- **自動適用範囲**: PR説明ワークフロー専用、コードやテスト生成には影響しない

### コンテキスト依存適用の重要性
これらの指示はそれぞれ関連する明示的にトリガーされたシナリオでのみ適用される。例えば、testGeneration.instructionsは直接テスト生成を要求した場合にのみ使用され、通常のコード生成やレビュー操作には影響しない。この文脈依存型の適用により、VS Codeインターフェースで実行している特定のタスクタイプに基づいて、Copilotの応答が適切に調整される。

## Prompt Files（プロンプトファイル）の目的と特徴

### 目的
Prompt Filesは、コード生成やコードレビューなどの共通タスクに対する再利用可能なプロンプトを定義するために使用される。これは「何が実行されるべきか」というタスク自体を記述し、チャットで直接実行できるスタンドアロンプロンプトとして機能する。

### 構造と機能
Prompt Filesは`.prompt.md`拡張子を持つMarkdownファイルで、以下の構成要素を含む：

1. **ヘッダー（Front Matter）**: モード（ask、edit、agent）、利用可能なツール、説明などのメタデータ
2. **本文**: Markdown形式でのプロンプト内容、他のファイルやプロンプトファイルへの参照、変数の使用が可能

### 変数システム
Prompt Filesでは`${variableName}`構文を使用して以下の変数を参照できる：
- ワークスペース変数（`${workspaceFolder}`）
- 選択範囲変数（`${selection}`）
- ファイルコンテキスト変数（`${file}`）
- 入力変数（`${input:variableName}`）

## InstructionsとPromptsの根本的な違い

### 機能面での違い
- **Instructions**: タスクの実行方法（How）を定義し、自動的にすべてのチャットリクエストに適用される
- **Prompts**: 実行するタスク（What）を定義し、明示的に呼び出す必要がある

### 適用範囲の違い
- **Instructions**: 継続的にバックグラウンドで適用され、開発者の意識的な操作なしに機能する
- **Prompts**: 特定のタスクを実行する際に意図的に選択・実行される

### 組み合わせの利点
Prompt FilesからCustom Instructionsを参照することで、タスク固有の指示と一般的なガイドラインを効率的に組み合わせることができる。例えば、セキュリティレビュー用のPrompt Fileが一般的なセキュリティ慣行のInstructionsを参照しつつ、レビュー結果の報告方法について具体的な指示を含むことが可能である。

## Markdown Linkによるファイル間の間接参照

### 参照メカニズム
VS CodeのCopilot Customizationでは、Markdown Link記法を使用してファイル間の間接参照が可能である。この機能により、複雑な指示やプロンプトを管理しやすい小さな単位に分割し、必要に応じて組み合わせることができる。

### 参照可能なファイルタイプ
1. **ワークスペースファイル**: `[index](../index.ts)`形式や`#index.ts`形式で参照
2. **他のPrompt Files**: プロンプトの階層構造を作成可能
3. **Instructions Files**: 共通ガイドラインの再利用を促進

### 相対パスの重要性
ファイル参照は相対パスを使用する必要があり、参照元ファイルの場所に基づいて正確なパスを指定することが重要である。これにより、ファイル構造の変更に対する堅牢性が向上し、チーム間でのファイル共有が容易になる。

## 批判的視点と課題

### 設定管理の複雑性
複数の設定方法（ファイルベース、設定ベース）が存在することで、設定の重複や競合が発生する可能性がある。特に、チーム開発において一貫性を保つためには、明確な設定ガイドラインの策定が必要である。

### スコープ管理の課題
ワークスペースレベルとユーザーレベルの設定が混在することで、予期しない動作や設定の優先順位に関する混乱が生じる可能性がある。開発者は設定の適用範囲を明確に理解する必要がある。

### タスク固有Instructions設定の認識ギャップ
各タスク固有のinstructions設定（テスト生成、コードレビューなど）は明示的なトリガーが必要であるという事実を開発者が理解していない場合、期待した動作が得られない可能性がある。例えば、testGeneration.instructionsを設定したが、一般的なコード生成時にテスト関連の指示が適用されないことで混乱が生じるケースが想定される。

### 学習コストと導入障壁
効果的なCustom InstructionsやPrompt Filesを作成するには、Markdown記法、Front Matter構文、変数システムなどの理解が必要であり、初期の学習コストが高い。また、組織レベルでの導入には、ベストプラクティスの策定と教育が重要である。さらに、どのタスクでどのinstructions設定が適用されるかの理解も必要となり、学習すべき範囲が広い。

## 関連ノート

- [[Claude_Code_使える環境と動作概要]] - Claude Codeの動作環境と基本機能の解説
- [[Claude-Code-Best-Practices]] - Claude Code活用のベストプラクティス
- [[Building Effective Agents_Anthropic]] - Anthropicによる効果的なAIエージェント構築指針
- [[GitHubCopilotの開発プロセスへの適用]] - Copilotのカスタマイゼーション機能をウォーターフォール開発工程で活用する戦略

#vscode #githubcopilot #ai #prompt #onboarding


[//begin]: # "Autogenerated link references for markdown compatibility"
[Claude_Code_使える環境と動作概要]: Claude_Code_%E4%BD%BF%E3%81%88%E3%82%8B%E7%92%B0%E5%A2%83%E3%81%A8%E5%8B%95%E4%BD%9C%E6%A6%82%E8%A6%81.md "Claude Codeの使える環境と動作概要"
[Claude-Code-Best-Practices]: Claude-Code-Best-Practices.md "Claude Code Best Practices"
[Building Effective Agents_Anthropic]: <Building Effective Agents_Anthropic.md> "Building Effective Agents（Anthropic要約）"
[//end]: # "Autogenerated link references"
