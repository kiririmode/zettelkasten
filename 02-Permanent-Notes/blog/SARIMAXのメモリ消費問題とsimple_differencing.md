# SARIMAXのメモリ消費問題とsimple_differencingによる解決

## はじめに：現場で遭遇したメモリエラー

時系列解析でSARIMAモデルのハイパーパラメータ探索をAICで行う際、`statsmodels.tsa.SARIMAX`を何度も呼び出していると、以下のようなエラーに頻繁に遭遇した。

```
numpy._core_.exceptions._ArrayMemoryError: Unable to allocate 4.27 GiB for an array with shape (n, n, d) and data type float64 ...
```

- データは2,000行程度、float64型、外生変数なし
- パラメータ1セットのfitでもメモリエラーでプロセスが落ちる
- 並列処理や探索空間の広さに関係なく単体実行でも発生
- Windows環境で顕著

---

## なぜSARIMAXでメモリエラーが起きるのか？

SARIMAXは、状態空間モデルの内部で「差分系列」を逐次的に計算・保持する。この際、BLAS/LAPACKの実装やPython環境によっては、不要に巨大な行列（例：shapeが(n, n, d)の三次元配列）を一時的に確保しようとし、データ量が小さくてもメモリ不足に陥ることがある。

- statsmodelsやnumpy/scipyのバージョン依存バグ
- Python環境の競合やデータ内容（NaN, inf, 極端値）も影響
- 特にWindowsや一部のBLAS実装で発生しやすい

---

## simple_differencing=True でなぜ解決するのか？

`sarimax(..., simple_differencing=True)`を指定すると、モデル内部での差分計算をやめ、事前に差分済みデータを使って推定を行う。これにより、冗長なデータコピーや巨大な行列演算が不要となり、メモリ消費が劇的に減少する。

- fitの計算時間も短縮される場合が多い
- 実際にこのオプションで_ArrayMemoryErrorが解消し、処理も高速化

### 実装例

```python
import numpy as np
from statsmodels.tsa.statespace.sarimax import SARIMAX

y = np.random.randn(2000).astype(np.float64)
model = SARIMAX(y, order=(1,1,1), seasonal_order=(1,1,1,12),
                enforce_stationarity=False, enforce_invertibility=False,
                simple_differencing=True)
results = model.fit(disp=False)
```

---

## メリットとデメリット

### メリット
- メモリ消費が大幅に抑制される
- fitの計算時間が短縮される
- statsmodels特有の実装トラブルを回避できる

### デメリット・注意点
- 欠損値や系列長の扱いが変わり、推定結果が微妙に異なる場合がある
- 外生変数や複雑な季節構造では再現性に注意
- バージョンやモデル設定によってはサポートされていない場合も
- 差分前後で統計的性質が変化するため、理論的解釈や残差分析に注意

---

## まとめと推奨

SARIMAXのメモリ消費問題は、内部の差分処理と行列演算の実装に起因することが多い。`simple_differencing=True`は、特にデータ量が小さいのにメモリエラーが出る場合、まず試すべき有効な解決策である。ただし、推定結果や系列の性質が変わる可能性もあるため、理論的な意味や再現性を意識しつつ活用したい。

---

## 関連ノート・リンク推奨
- [[SARIMAによる時系列異常検知の基礎]]

---

## タグ
#時系列解析 #sarima #statsmodels #メモリ最適化 #python #実装トラブル


[//begin]: # "Autogenerated link references for markdown compatibility"
[SARIMAによる時系列異常検知の基礎]: ../SARIMA%E3%81%AB%E3%82%88%E3%82%8B%E6%99%82%E7%B3%BB%E5%88%97%E7%95%B0%E5%B8%B8%E6%A4%9C%E7%9F%A5%E3%81%AE%E5%9F%BA%E7%A4%8E.md "SARIMAによる時系列異常検知の基礎"
[//end]: # "Autogenerated link references"
