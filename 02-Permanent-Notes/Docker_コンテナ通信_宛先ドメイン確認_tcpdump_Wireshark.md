# Dockerコンテナ通信の宛先ドメイン確認方法

## 定義・概要
Dockerコンテナから発生する通信がどのドメイン宛に送信されているかを把握することは、セキュリティや運用上の重要な要件である。本ノートでは、tcpdumpおよびWiresharkを用いて、docker0インタフェース経由の通信先ドメインを特定する方法について解説する。

## 詳細コンテンツ
### docker0インタフェースとは何か
公式ドキュメントによれば、docker0はDockerデーモンが自動的に作成するデフォルトのブリッジネットワークインタフェースである。これはLinuxカーネル上のソフトウェアブリッジであり、同じブリッジネットワークに接続されたコンテナ同士の通信を可能にし、異なるネットワーク間の分離も担う（[Docker公式](https://docs.docker.com/network/bridge/)）。

### macOSにおける注意点と代替手法
macOSではLinuxと異なりdocker0インタフェースは存在しない。Docker Desktop for Macは仮想化技術（HyperKit等）を利用しており、ネットワーク構造が異なるためである。macOSでDockerコンテナ通信のパケットキャプチャを行うには、以下の方法が有効である。

#### 1. ループバックインタフェース（lo0）でのキャプチャ
多くの場合、コンテナ⇔ホスト間や外部との通信はlo0やen0（Wi-Fi）などを通る。例えば、lo0でパケットキャプチャするには：
```bash
sudo tcpdump -i lo0
```

#### 2. 仮想ネットワークインタフェース（vnic*）の利用
`ifconfig`コマンドで`vnic0`や`vnic1`など、Docker Desktopが作成する仮想NICが見つかる場合がある。これらのインタフェースでキャプチャすることで、コンテナの外部通信を観測できることがある。
```bash
sudo tcpdump -i vnic0
```

#### 3. Wiresharkのインタフェース選択
Wiresharkを使う場合、利用可能なインタフェース一覧から`vnic*`や`bridge*`などを選択し、パケットをキャプチャする。

#### 4. コンテナ内でtcpdumpを実行
より確実にコンテナの通信を取得したい場合、対象コンテナ内にtcpdumpをインストールし、直接キャプチャする。
```bash
docker exec -it <container_name> apk add tcpdump   # Alpineの場合
docker exec -it <container_name> tcpdump -i eth0
```

### tcpdumpによる監視とドメイン名の特定（Linux向け）
tcpdumpでdocker0インタフェースを監視すると、パケットから宛先IPアドレスを取得できる。しかし、IPアドレスだけではドメイン名は分からないため、通常は各IPアドレスに対して逆引きDNS（dig -x）を行う必要がある。

#### 代表的なコマンド例（Linux）
```bash
# docker0インタフェース上の全トラフィックをキャプチャし、ファイルに保存
sudo tcpdump -i docker0 -nn -w container_traffic.pcap
```
このファイルをWiresharkで開くことで、詳細な通信解析やドメイン名の可視化が可能となる。

#### 効率化のためのアプローチ
- DNSパケット（UDP 53番）も同時にキャプチャすることで、どのIPアドレスがどのドメイン名に対応しているかをリアルタイムで把握できる。
  例：
  ```bash
  sudo tcpdump -i docker0 port 53
  ```
  この結果から、クエリされたドメイン名と返されたIPアドレスの対応を抽出できる。

### Wiresharkによる可視化
Wiresharkはtcpdumpで取得したパケットファイル（pcap）をGUIで解析できる。Wiresharkの「名前解決」機能を有効にすると、宛先IPアドレスが自動的にドメイン名に変換され、通信先を直感的に把握できる。

## 批判的視点・反論
- macOSのネットワーク構造はLinuxと異なり、全ての通信がホスト側で観測できるとは限らない。
- vnicやlo0でキャプチャしても、NATや仮想化の影響で一部の通信が見えない場合がある。
- セキュリティや権限の制約でパケットキャプチャが制限されることがある。
- 逆引きDNS（dig -x）は必ずしも正確なドメイン名を返すとは限らない。
- DNSキャッシュやCDNの影響で、IPとドメインの対応が一意でない場合がある。
- DNSパケットをキャプチャしても、全ての通信が必ずしもDNSクエリを伴うとは限らない（例：IP直指定通信）。

## 関連ノート/リンク
- [[tsharkコマンド_Wiresharkコマンドライン版パケット解析]]
- [[tcpdump_パケットキャプチャ専門解説]]
- [[Claude_Code_ネットワーク要件まとめ]]

#docker #macos #network #packetcapture

[//begin]: # "Autogenerated link references for markdown compatibility"
[Claude_Code_ネットワーク要件まとめ]: Claude_Code_%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E8%A6%81%E4%BB%B6%E3%81%BE%E3%81%A8%E3%82%81.md "Claude Codeに必要なネットワーク要件まとめ"
[tcpdump_パケットキャプチャ専門解説]: tcpdump_%E3%83%91%E3%82%B1%E3%83%83%E3%83%88%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E5%B0%82%E9%96%80%E8%A7%A3%E8%AA%AC.md "tcpdump パケットキャプチャ専門解説"
[//end]: # "Autogenerated link references"
